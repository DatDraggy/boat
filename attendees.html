<?php
require_once('backend/config.php');
require_once('backend/funcs.php');
require_once('backend/includes.php');
header('Cache-Control: max-age=0');

$dbConnection = buildDatabaseConnection($config);

$showButtons = false;
if (getConfirmedAttendees() < $config['attendeesMax']) {
  $showButtons = true;
}

$sql = "SELECT nickname, `rank`, sponsor FROM users WHERE status > 1 AND list = true ORDER BY nickname";
$stmt = $dbConnection->prepare('SELECT nickname, `rank`, sponsor FROM users WHERE status > 1 AND list = true ORDER BY nickname');
$stmt->execute();
$rows = $stmt->fetchAll();
$attendees = '<ul>';
foreach ($rows as $row) {
  $nickname = htmlspecialchars($row['nickname']);
  if ($row['rank'] == 1) {
    $nickname .= ' <span class="rank">Crew</span>';
  } else if ($row['rank'] >= 2) {
    $nickname .= ' <span class="rank">Staff</span>';
  } else if ($row['sponsor'] == 1) {
    $nickname .= ' <span class="rank">VIP</span>';
  }
  $attendees .= '<li>' . $nickname . "</li>\n";
}
$attendees .= '</ul>';
?>
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <title>Hot Summer Nights: Furry Summerbo.at Party</title>
    <?php echo $head; ?>
	  <style>.rank {color:lightrey}</style>
  </head>
  <body class="hasNav">
    <div id="app">
      <?php echo $nav; ?>

      <section id="contentPage">
		<!-- ========== Info text ========== -->

        <section id="about" class="ribbon" style="background-color: var(--colorPink)">
          <div class="wrapper">
            <div class="row">
              <div style="color:white" class="content wsLarge">
                <h1>Attendee List</h1>
                <p class="textBig">The one and only crew list for the boatparty! All people on this list are going to party hard on the coolest ship of Berlin. Don't see yourself yet?</p>
				        <?php if($showButtons) { ?><div class="buttonGroup">
                  <a class="button buttonPrimary" href="register" title="Get a ticket">Register
                    Now</a>
                  <a class="button buttonUpgrade" href="register?vip" title="Upgrade to VIP">Upgrade to VIP</a>
                </div>
                <?php } ?>
              </div>
            </div>
          </div>
        </section>

        <section class="wrapper wsLarge">
        <div class="row">
        <h2 class="headline">Attendees</h2>
        </div>
          <div class="row" id="attendeeList">
		      <?php echo $attendees; ?>
		    </div>
        </section>
      </section> <!--pageWrapper -->
      <?php echo $footer; ?>
  </body>
</html>
