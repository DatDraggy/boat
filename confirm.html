<?php
require_once('backend/config.php');
require_once('backend/funcs.php');
header('Cache-Control: max-age=0');
if (!empty($_GET['token'])) {
  $token = $_GET['token'];
  $dbConnection = buildDatabaseConnection($config);

  if(isset($_GET['email'])){
    if (confirmEmail($token)) {
      session_start();
      $status = 'Email changed';
      $_SESSION['statusSuccess'] = $status;
      header('Location: user/');
      //Email Changed, Goto login
      die($status);
    }
    else {
      $_SESSION['status'] = 'Something went wrong';
    }
  }
  else if(isset($_GET['emailold'])){
    if (confirmNewEmail($token)) {
      session_start();
      $status = 'A confirmation has been sent to the new email';
      $_SESSION['statusSuccess'] = $status;
      header('Location: user/');
      //Email Changed, Goto login
      die($status);
    }
    else {
      $_SESSION['status'] = 'Something went wrong';
    }
  }
  else if(isset($_GET['password'])){
    header('Location: password?token='.$token);
  }
  else {
    session_start();
    $status = 'Registration Successful';
    $_SESSION['status'] = $status;
    session_commit();
    header('Location: login?reg');
    if (confirmRegistration($token)) {
      //Email Confirmed, goto login, wait for staff approval
      die($status);
    }
  }
}
else {
  header('Location: login');
  die();
}