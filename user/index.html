<?php
require_once('../backend/config.php');
require_once('../backend/funcs.php');
require_once('../backend/includes.php');
header('Cache-Control: max-age=0');
session_start();
if (empty($_SESSION['userId'])) {
  session_commit();
  header('Location: ../login');
  die();
}
$userId = $_SESSION['userId'];
session_commit();
$dbConnection = buildDatabaseConnection($config);

////////////////////////
// Check Reg Validity //
if (!checkRegValid($userId)) {
  //If invalid, kill that bih
  if (isset($_COOKIE[session_name()])) {
    setcookie(session_name(), '', time() - 3600, '/');
  }
  session_destroy();
  header('Location: ../login.html');
  die();
}
// Check Reg Validity //
////////////////////////

$details = getRegDetails($userId, 'nickname, status, locked');
$userStatus = $status[$details['status']];
$nickname = $details['nickname'];
$locked = $details['locked'];

$leftToPay = getBalanceDetails($userId, 'topay - paid as leftToPay')['leftToPay'];

$payments = getPaymentDetails($userId, 'date, amount');
$paymentsHtml = '<table class="payments"><th>Date</th><th>Amount</th>';

if (is_array($payments)) {
  foreach ($payments as $payment) {
    $amount = $payment['amount'];
    $date = date('Y-m-d', $payment['date']);

    $paymentsHtml .= '<tr><td class="date">' . $date . '</td> <td class="amount">' . $amount . '€</td></tr>';
  }
}
$paymentsHtml .= '</table>';

?>

<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <title>Hot Summer Nights: Furry Summerbo.at Party</title>
    <?php echo $head; ?>
  </head>
  <body class="hasNav">
    <div id="app">
      <?php echo $nav; ?>

      <section id="contentPage">
        <!-- ========== Info text ========== -->

        <section id="about" class="ribbon" style="background-color: var(--colorPink)">
          <div class="wrapper">
            <div class="row">
              <div style="color:white" class="content wsLarge">
                <h1>User Area</h1>
                <p class="textBig">Welcome <?php echo $nickname; ?>. This is your own user area with all information regarding
			your registration for the next party. Look below to see your payment transactions and status details.</p>
                <p>If you want to edit the rest of your details, please click on the button below to go to your details.</p>
                <div class="buttonGroup">
                  <a class="button buttonUpgrade" href="details" title="Edit Details">Edit Details</a>
                  <a class="button buttonUpgrade" href="../logout" title="Logout">Logout</a>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="wrapper wsLarge">
          <div class="row">
            <h1 class="headline">Payments</h1>
          </div>
          <div class="row">
            <p>Your current registration status is
              <strong><?php echo $userStatus; ?></strong>.<br><?php if ($locked) { ?>
                <!--never shown anyway!-->
		<span style="color:red">
	 	   However, your account is locked. You do <u>not</u> have a reserved seat.
		</span><br>
		If we're booked out, you unfortunately can't attend. However, if seats become available, we will let you
		know to give you a second chance.<br><?php } ?>
	      Below you can find all the payments we received.</p>
          </div>
          <?php if ($leftToPay > 0) { ?>
            <div class="row">
              <p>You still have some fees due. Please use the payment details below to pay your fees.</p>
            </div>
            <div class="row">
              <p>We kindly ask for payments being made via bank transfer (SEPA). Please try to do it this way!
		      If you really can't, please contact us for alternative payment methods.</p>
            </div>
            <!--<div class="row">
              <p><strong>How does Transferwise work?</strong></p>
            </div>
            <div class="row">
              <p>If you want to use one of the other payment options you do have to create an account at Transferwise. You can also use your Google or Facebook account for it.
                There is no extra identy check needed if you want to send money to us. Simply click on Send Money and use our IBAN to make sure it goes to the right account. Check their <a"href="https://www.transferwise.com">website</a> for more information.</p>
            </div>-->
            <div class="row"><p>The bank details are:</p></div>
            <div class="row">
              <div>
                <p class="team" style="padding-left: 2rem;padding-right: 2em;">
                  <strong>Name:</strong> Edwin Verstaij<br>
                  <strong>IBAN:</strong> DE68 7001 1110 6054 4164 13<br>
                  <strong>BIC/SWIFT:</strong> DEKTDE7GXXX<br>
                  <strong>Currency:</strong> Euros<br>
                  <strong>Amount:</strong> <?php echo $leftToPay; ?>€<br>
                  <strong>Comment:</strong> <?php echo "$userId + $nickname"; ?><br><br>
                  <strong>Bank Address:</strong><br> Handelsbank<br>
                  Elsenheimer Str. 41<br>
                  80687 München<br>
                  Germany<br>
                </p>
              </div>
            </div>
            <div class="row">
              <p>Don't you see your payment below in the history? Normally we receive the money within a few working days.
		 International transaction might need some more time. If you don't receive a payment confirmation within a week
		 please check if all details were filled correctly, and if so, please send us an email with a proof of payment
		 so we can sort it out for you.
              </p>
            </div>
          <?php } ?>
          <div class="row">
            <h2 id="payhis" class="headline">Payment History</h2>
          </div>
          <div class="row">
            <?php echo $paymentsHtml; ?>
          </div>

        </section>
      </section> <!--pageWrapper -->
      <?php echo $footer; ?>
  </body>
</html>
